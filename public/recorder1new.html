<!DOCTYPE html>
<html>
  <head>
    <title>Voice Recorder</title>
  </head>
  <body>
    <h2>ğŸ™ï¸ Voice Recorder</h2>
    <button id="startBtn">â–¶ï¸ Start Recording</button>
    <button id="stopBtn" disabled>â¹ï¸ Stop</button>
    <p id="status"></p>
    <p id="resultText"></p>

    <script>
      let mediaRecorder;
      let audioChunks = [];

      const startBtn = document.getElementById('startBtn');
      const stopBtn = document.getElementById('stopBtn');
      const statusText = document.getElementById('status');

      startBtn.onclick = async () => {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          mediaRecorder = new MediaRecorder(stream, {
            mimeType: 'audio/webm;codecs=opus'
          });

          audioChunks = [];

          mediaRecorder.ondataavailable = (e) => {
            if (e.data.size > 0) audioChunks.push(e.data);
          };

          mediaRecorder.onstop = async () => {
            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
            const formData = new FormData();
            formData.append('file', audioBlob, 'recording.webm');

            statusText.textContent = 'ğŸ”„ Uploading audio...';

            try {
              const response = await fetch('https://yellme.vercel.app/api/uploadRecording', {
                method: 'POST',
                body: formData
              });

              const result = await response.json();

              if (!result.upload_url) {
                statusText.textContent = 'âš ï¸ Audio upload failed.';
                return;
              }

              statusText.textContent = 'âœ… Audio uploaded: ' + result.upload_url;

              // Procesar el audio
              const processResponse = await fetch('https://yellme.vercel.app/api/processRecording', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ upload_url: result.upload_url, user_id: 'user123' })
              });

              const processResult = await processResponse.json();

              document.getElementById('resultText').textContent =
                'ğŸ“¥ Processed result: ' + JSON.stringify(processResult);

            } catch (err) {
              console.error('âŒ Upload error:', err);
              statusText.textContent = 'âŒ Error uploading audio.';
            }
          };

          mediaRecorder.start();
          statusText.textContent = 'ğŸ™ï¸ Recording...';
          startBtn.disabled = true;
          stopBtn.disabled = false;
        } catch (err) {
          console.error('ğŸ™ï¸ Microphone error:', err);
          statusText.textContent = 'âŒ Microphone access error.';
        }
      };

      stopBtn.onclick = () => {
        mediaRecorder.stop();
        startBtn.disabled = false;
        stopBtn.disabled = true;
      };
    </script>
  </body>
</html>
